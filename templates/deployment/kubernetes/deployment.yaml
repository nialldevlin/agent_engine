apiVersion: apps/v1
kind: Deployment
metadata:
  name: agent-engine
  namespace: agent-engine
  labels:
    app: agent-engine
    version: v1
  annotations:
    description: "Agent Engine - Multi-agent LLM orchestration"

spec:
  replicas: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0

  selector:
    matchLabels:
      app: agent-engine

  template:
    metadata:
      labels:
        app: agent-engine
        version: v1
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8000"
        prometheus.io/path: "/metrics"

    spec:
      # Service account
      serviceAccountName: agent-engine

      # Security context (pod level)
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000
        seccompProfile:
          type: RuntimeDefault

      # Restart policy
      restartPolicy: Always

      # Termination grace period
      terminationGracePeriodSeconds: 30

      # Init containers (setup tasks)
      initContainers:
        - name: config-validator
          image: agent-engine:latest
          imagePullPolicy: IfNotPresent
          command: ["python", "-m", "agent_engine.schema_validator"]
          env:
            - name: AGENT_ENGINE_CONFIG_DIR
              value: /app/config
          volumeMounts:
            - name: config
              mountPath: /app/config
              readOnly: true

      # Main containers
      containers:
        - name: agent-engine
          image: agent-engine:latest
          imagePullPolicy: IfNotPresent

          # Port configuration
          ports:
            - name: metrics
              containerPort: 8000
              protocol: TCP
            - name: http
              containerPort: 8080
              protocol: TCP

          # Environment variables
          env:
            # Core configuration
            - name: AGENT_ENGINE_ENV
              value: production
            - name: AGENT_ENGINE_CONFIG_DIR
              value: /app/config
            - name: LOG_LEVEL
              value: INFO

            # Pod metadata
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP

            # API Keys (from secrets)
            - name: ANTHROPIC_API_KEY
              valueFrom:
                secretKeyRef:
                  name: agent-credentials
                  key: anthropic-api-key
            - name: OPENAI_API_KEY
              valueFrom:
                secretKeyRef:
                  name: agent-credentials
                  key: openai-api-key

            # Database connection
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: agent-credentials
                  key: database-url
                  optional: true

            # Python configuration
            - name: PYTHONUNBUFFERED
              value: "1"
            - name: PYTHONPATH
              value: /app:/usr/lib/python3/dist-packages

          # Volume mounts
          volumeMounts:
            # Configuration (read-only)
            - name: config
              mountPath: /app/config
              readOnly: true

            # Data storage
            - name: data
              mountPath: /app/data

            # Logs
            - name: logs
              mountPath: /app/logs

            # Artifacts
            - name: artifacts
              mountPath: /app/artifacts

          # Resource management
          resources:
            requests:
              memory: "512Mi"
              cpu: "250m"
            limits:
              memory: "2Gi"
              cpu: "1000m"

          # Probes
          livenessProbe:
            exec:
              command:
                - python
                - /app/scripts/healthcheck.py
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
            successThreshold: 1

          readinessProbe:
            exec:
              command:
                - python
                - /app/scripts/healthcheck.py
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 2
            successThreshold: 1

          startupProbe:
            exec:
              command:
                - python
                - /app/scripts/healthcheck.py
            initialDelaySeconds: 0
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 30

          # Security context (container level)
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false
            runAsNonRoot: true
            runAsUser: 1000
            capabilities:
              drop:
                - ALL

          # Lifecycle hooks
          lifecycle:
            preStop:
              exec:
                command: ["/bin/sh", "-c", "sleep 5"]

      # Volumes
      volumes:
        # Configuration (from ConfigMap)
        - name: config
          configMap:
            name: agent-engine-config
            defaultMode: 0444

        # Data (EmptyDir for stateless, PVC for persistence)
        - name: data
          emptyDir: {}

        # Logs
        - name: logs
          emptyDir: {}

        # Artifacts
        - name: artifacts
          emptyDir: {}

      # Affinity rules
      affinity:
        # Pod anti-affinity: spread across nodes
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                        - agent-engine
                topologyKey: kubernetes.io/hostname

        # Node affinity: prefer nodes with specific labels
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 50
              preference:
                matchExpressions:
                  - key: node-type
                    operator: In
                    values:
                      - agent-compute
